---
import fs from 'node:fs/promises';
import nodePath from "node:path"
import highlightCache from './CodeHighlight/cache';
import astroHighlightCode from "./CodeHighlight/astroHighlightCode"

const { path, lang, theme = 'github-dark', wrap = false } = Astro.props;

const fileStat = await fs.stat(path)
const cacheKey = `${path}-${fileStat.mtimeMs}`

if(!highlightCache.has(cacheKey)){
    highlightCache.cleanKeyStartsWith(path)
    const fileContent = await fs.readFile(path, "utf-8")
    const fileExt = nodePath.parse(path).ext.split(".").pop()
    const html = await astroHighlightCode({ code: fileContent, lang: lang || fileExt, theme, wrap })
    highlightCache.set(cacheKey, html)
}

const html = highlightCache.get(cacheKey)
---

<Fragment set:html={html} />